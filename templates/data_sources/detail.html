{% extends "base.html" %}

{% block title %}
    {{ data_source.name }} Detail
{% endblock %}

{% block content %}
    <h1>{{ data_source.name }}</h1>
    <p><strong>Description:</strong> {{ data_source.description }}</p>
    <p><strong>Upload Date:</strong> {{ data_source.upload_date|date:"M d, Y H:i" }}</p>
    <p><strong>Status:</strong> <span class="badge bg-{{ data_source.status|lower }}">{{ data_source.status }}</span></p>

    <hr>

    <h2>ðŸ“Š Extracted Metadata Summary</h2>

    {% if data_source.processed_metadata %}
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Metadata Field</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                {# Iterate over the dictionary of processed metadata #}
                {% for key, value in extracted_metadata.items %}
                    <tr>
                        <td><strong> {{ key|capfirst|make_list|join:" " }} </strong></td>
                        <td>
                            {# Check if the value is a list (like column names) or a dictionary (like Excel sheets) #}
                            {% if value|length > 0 and value|first is iterable and value is not string %}
                                {# Handle complex data structures like lists or nested dictionaries #}
                                <details>
                                    <summary>View {{ key|capfirst }} ({{ value|length }} entries)</summary>
                                    <ul>
                                    {# This inner loop handles nested structure like Excel sheets or JSON arrays #}
                                    {% for sub_key, sub_value in value.items|default:value %}
                                        <li>
                                            {% if sub_value is not string and sub_value is iterable %}
                                                {# If the value is another dict (e.g., an Excel sheet's summary) #}
                                                <strong>{{ sub_key }}:</strong> 
                                                <ul>
                                                {% for nested_key, nested_value in sub_value.items %}
                                                    <li>{{ nested_key }}: {{ nested_value }}</li>
                                                {% endfor %}
                                                </ul>
                                            {% else %}
                                                {# Simple list item #}
                                                {{ sub_key }}: {{ sub_value }}
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                    </ul>
                                </details>
                            {% else %}
                                {# Display simple key-value pair #}
                                {{ value }}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="alert alert-warning">No metadata has been processed for this data source yet.</p>
    {% endif %}

    <a href="{% url 'data_source_list' %}" class="btn btn-secondary">Back to List</a>

{% endblock %}